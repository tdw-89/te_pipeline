/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Transposable Element (TE) Pipeline Configuration
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Configuration for running on UMass Unity cluster with Apptainer/Singularity
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
*/

// Global default params
params {
    // Input/output options
    input         = null  // Path to input genome FASTA file
    outdir        = 'results'

    // Max resource options (based on Unity profile limits)
    max_memory = 2.TB
    max_cpus = 192
    max_time = 14.d

    // Boilerplate options
    help          = false
}

// Process-specific resource requirements
process {
    withLabel: 'process_single' {
        cpus   = 1
        memory = 4.GB
        time   = 4.h
    }
    withLabel: 'process_low' {
        cpus   = 2
        memory = 8.GB
        time   = 8.h
    }
    withLabel: 'process_medium' {
        cpus   = 8
        memory = 32.GB
        time   = 48.h
    }
    withLabel: 'process_high' {
        cpus   = 12
        memory = 64.GB
        time   = 72.h
    }

    resourceLimits = [
        cpus: 192,
        memory: 2.TB,
        time: 14.d
    ]
    executor = 'slurm'

    // Selects partition based on process time
    queue = { task.time <= 2.h ? 'cpu-preempt' : 'cpu' }
    clusterOptions = { "${task.time >= 48.h ? '-q long' : ''}" }

    maxRetries = 2
}

// Also based on Unity profile:
// Limits job submission to 1000 consecutive run and 20 submissions per second
executor {
    queueSize = 1000
    submitRateLimit = '20sec'
    pollInterval = '30sec'
    queueStatInterval = '1min'
}

singularity {
    enabled = true
    autoMounts = true
    pullTimeout = '120m'
}

// Load nf-core module configurations
includeConfig 'conf/modules.config'

// Capture exit codes from upstream processes when piping
process.shell = ['/bin/bash', '-euo', 'pipefail']

// Nextflow manifest
manifest {
    name            = 'te_pipeline'
    author          = 'TDW'
    homePage        = 'https://github.com/tdw-89/te_pipeline'
    description     = 'Pipeline for de novo transposable element identification'
    mainScript      = 'main.nf'
    nextflowVersion = '>=23.04.0'
    version         = '1.0.0'
}

// Trace, timeline, report and DAG generation
trace {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_trace.txt"
    overwrite = true
}
report {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_report.html"
    overwrite = true
}
timeline {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_timeline.html"
    overwrite = true
}
dag {
    enabled = true
    file    = "${params.outdir}/pipeline_info/pipeline_dag.svg"
    overwrite = true
}

// clean the generated files in the working directory
cleanup = true