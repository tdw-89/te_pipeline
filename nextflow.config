/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Transposable Element (TE) Pipeline Configuration
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Configuration for running on UMass Unity cluster with Apptainer/Singularity
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
*/

// Global default params
params {
    // Input/output options
    input         = null  // Path to input genome FASTA file
    outdir        = 'results'

    // Max resource options
    max_memory    = '128.GB'
    max_cpus      = 16
    max_time      = '240.h'

    // Boilerplate options
    help          = false
}

// Process-specific resource requirements
process {
    withLabel: 'process_single' {
        cpus   = 1
        memory = 4.GB
        time   = 4.h
    }
    withLabel: 'process_low' {
        cpus   = 2
        memory = 8.GB
        time   = 8.h
    }
    withLabel: 'process_medium' {
        cpus   = 8
        memory = 32.GB
        time   = 48.h
    }
    withLabel: 'process_high' {
        cpus   = 12
        memory = 64.GB
        time   = 72.h
    }
}

// Profiles configuration
profiles {
    singularity {
        singularity.enabled    = true
        singularity.autoMounts = true
        docker.enabled         = false
        podman.enabled         = false
        shifter.enabled        = false
        charliecloud.enabled   = false
        apptainer.enabled      = false
    }
    apptainer {
        apptainer.enabled      = true
        apptainer.autoMounts   = true
        docker.enabled         = false
        podman.enabled         = false
        shifter.enabled        = false
        charliecloud.enabled   = false
        singularity.enabled    = false
    }
    docker {
        docker.enabled         = true
        docker.userEmulation   = true
        singularity.enabled    = false
        podman.enabled         = false
        shifter.enabled        = false
        charliecloud.enabled   = false
        apptainer.enabled      = false
    }
    test {
        // Minimal test dataset
        params.max_cpus   = 2
        params.max_memory = 6.GB
        params.max_time   = 6.h
    }
    unity {
        // UMass Unity cluster profile with Apptainer
        apptainer.enabled      = true
        apptainer.autoMounts   = true
        docker.enabled         = false
        podman.enabled         = false
        shifter.enabled        = false
        charliecloud.enabled   = false
        singularity.enabled    = false
        process.executor       = 'slurm'
    }
}

// Load nf-core module configurations
includeConfig 'conf/modules.config'

// Capture exit codes from upstream processes when piping
process.shell = ['/bin/bash', '-euo', 'pipefail']

// Nextflow manifest
manifest {
    name            = 'te_pipeline'
    author          = 'TDW'
    homePage        = 'https://github.com/tdw-89/te_pipeline'
    description     = 'Pipeline for de novo transposable element identification'
    mainScript      = 'main.nf'
    nextflowVersion = '>=23.04.0'
    version         = '1.0.0'
}

// Trace, timeline, report and DAG generation
def timestamp = new java.text.SimpleDateFormat("yyyy-MM-dd_HH-mm-ss").format(new java.util.Date())
trace {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_trace_${timestamp}.txt"
}
report {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_report_${timestamp}.html"
}
timeline {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_timeline_${timestamp}.html"
}
dag {
    enabled = true
    file    = "${params.outdir}/pipeline_info/pipeline_dag_${timestamp}.svg"
}
